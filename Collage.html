<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>BCKV Field Data Card Generator</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    
    <style>
        :root {
            --border-color: #1a5e1a; /* Dark Green */
            --text-maroon: #990033;
            --text-brown: #5c2821;
            --bg-color: #ffffff;
        }

        body {
            font-family: 'Arial', sans-serif;
            background-color: #f0f0f0;
            display: flex;
            flex-direction: column;
            align-items: center;
            margin: 0;
            padding: 20px;
            /* Prevent scrolling while manipulating images on mobile */
            overscroll-behavior: none; 
        }

        /* Controls Section */
        .controls {
            margin-bottom: 20px;
            padding: 15px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            text-align: center;
            width: 100%;
            max-width: 800px;
        }

        .btn {
            padding: 10px 20px;
            margin: 5px;
            cursor: pointer;
            background-color: var(--border-color);
            color: white;
            border: none;
            border-radius: 4px;
            font-size: 14px;
        }

        .btn:hover { opacity: 0.9; }
        
        .instructions {
            font-size: 12px;
            color: #666;
            margin-top: 5px;
        }

        /* The Main A4 Sheet */
        #canvas-container {
            width: 794px; /* A4 width at 96dpi */
            height: 1123px; /* A4 height at 96dpi */
            background-color: white;
            border: 8px solid var(--border-color); /* The thick green border */
            box-sizing: border-box;
            padding: 15px;
            position: relative;
            box-shadow: 0 0 15px rgba(0,0,0,0.2);
            display: flex;
            flex-direction: column;
            /* Ensure touches inside don't scroll the page */
            touch-action: none; 
        }

        /* Layout Grid */
        .layout-grid {
            display: flex;
            flex-direction: column;
            gap: 15px;
            height: 100%;
        }

        /* Image Containers */
        .img-wrapper {
            position: relative;
            background-color: #eee;
            overflow: hidden;
            cursor: grab;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 1px dashed #ccc; /* Helper border, remove for print */
            touch-action: none;
        }

        .img-wrapper:active {
            cursor: grabbing;
        }

        .img-wrapper img {
            position: absolute;
            transform-origin: center;
            max-width: none; 
            user-select: none;
            pointer-events: none; 
        }

        /* Placeholder text */
        .placeholder-text {
            pointer-events: none;
            color: #888;
            font-size: 14px;
            text-align: center;
            position: absolute;
            z-index: 10;
        }

        /* Specific Sections */
        .top-section {
            width: 100%;
            height: 320px; 
            display: flex;
            flex-direction: column;
        }

        .middle-grid {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 15px;
            height: 250px;
        }

        .bottom-grid {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 15px;
            height: 250px;
        }

        /* Captions */
        .caption {
            text-align: center;
            font-size: 18px;
            color: black;
            margin-top: 5px;
            outline: none;
        }
        
        .caption:focus { border-bottom: 1px solid blue; }

        /* Footer Text */
        .footer-text {
            margin-top: auto;
            text-align: center;
            line-height: 1.4;
        }

        .group-info {
            color: var(--text-maroon);
            font-weight: bold;
            font-size: 18px;
            text-transform: uppercase;
        }

        .college-info {
            color: var(--text-brown);
            font-weight: bold;
            font-size: 20px;
            font-family: 'Arial Black', 'Impact', sans-serif;
            text-transform: uppercase;
        }

        /* File Inputs (Hidden) */
        input[type="file"] {
            display: none;
        }

        /* Print Specifics */
        @media print {
            body { 
                padding: 0; 
                background: white; 
            }
            .controls { display: none; }
            #canvas-container {
                border: 8px solid var(--border-color) !important;
                box-shadow: none;
                margin: 0;
                transform: scale(1) !important; /* Reset zoom for print */
                page-break-after: always;
            }
            .img-wrapper { border: none; background: transparent; }
            .placeholder-text { display: none; }
        }
        
        /* Mobile adjustment for preview */
        @media screen and (max-width: 850px) {
            #canvas-container {
                transform-origin: top left;
                transform: scale(0.45); /* Scale down visual for mobile screens */
                margin-bottom: -500px; /* Remove empty space caused by scaling */
            }
        }
    </style>
</head>
<body>

    <div class="controls">
        <h3>BCKV Field Data Card Generator</h3>
        <p class="instructions">
            <b>Desktop:</b> Drag to move, Scroll to zoom, Double-click to rotate.<br>
            <b>Mobile:</b> Drag to move, <b>Pinch to zoom</b>.<br>
            Click text to edit.
        </p>
        <button class="btn" onclick="downloadImage('jpeg')">Download JPEG</button>
        <button class="btn" onclick="downloadImage('png')">Download PNG</button>
        <button class="btn" onclick="downloadPDF()">Download PDF</button>
    </div>

    <div id="canvas-container">
        <div class="layout-grid">
            
            <div class="top-section">
                <div class="img-wrapper" id="img-top" style="height: 100%;" onclick="triggerUpload('file-top')">
                    <span class="placeholder-text">Click to Upload Paddy Field Image</span>
                </div>
                <div class="caption" contenteditable="true">Paddy Field</div>
                <input type="file" id="file-top" onchange="loadImage(this, 'img-top')">
            </div>

            <div class="middle-grid">
                <div style="display:flex; flex-direction:column;">
                    <div class="img-wrapper" id="img-m1" style="height: 100%;" onclick="triggerUpload('file-m1')">
                        <span class="placeholder-text">Upload</span>
                    </div>
                    <div class="caption" contenteditable="true">Harvesting of paddy</div>
                    <input type="file" id="file-m1" onchange="loadImage(this, 'img-m1')">
                </div>
                <div style="display:flex; flex-direction:column;">
                    <div class="img-wrapper" id="img-m2" style="height: 100%;" onclick="triggerUpload('file-m2')">
                        <span class="placeholder-text">Upload</span>
                    </div>
                    <div class="caption" contenteditable="true">Harvesting in group</div>
                    <input type="file" id="file-m2" onchange="loadImage(this, 'img-m2')">
                </div>
                <div style="display:flex; flex-direction:column;">
                    <div class="img-wrapper" id="img-m3" style="height: 100%;" onclick="triggerUpload('file-m3')">
                        <span class="placeholder-text">Upload</span>
                    </div>
                    <div class="caption" contenteditable="true">Threshing of paddy</div>
                    <input type="file" id="file-m3" onchange="loadImage(this, 'img-m3')">
                </div>
            </div>

            <div class="bottom-grid">
                <div style="display:flex; flex-direction:column;">
                    <div class="img-wrapper" id="img-b1" style="height: 100%;" onclick="triggerUpload('file-b1')">
                        <span class="placeholder-text">Upload</span>
                    </div>
                    <div class="caption" contenteditable="true">Winnowing</div>
                    <input type="file" id="file-b1" onchange="loadImage(this, 'img-b1')">
                </div>
                <div style="display:flex; flex-direction:column;">
                    <div class="img-wrapper" id="img-b2" style="height: 100%;" onclick="triggerUpload('file-b2')">
                        <span class="placeholder-text">Upload</span>
                    </div>
                    <div class="caption" contenteditable="true">Weighing of grain</div>
                    <input type="file" id="file-b2" onchange="loadImage(this, 'img-b2')">
                </div>
                <div style="display:flex; flex-direction:column;">
                    <div class="img-wrapper" id="img-b3" style="height: 100%;" onclick="triggerUpload('file-b3')">
                        <span class="placeholder-text">Upload</span>
                    </div>
                    <div class="caption" contenteditable="true">Weighing of straw</div>
                    <input type="file" id="file-b3" onchange="loadImage(this, 'img-b3')">
                </div>
            </div>

            <div class="footer-text">
                <div class="group-info" contenteditable="true">
                    GROUP R : AG 171, 172, 173, 174, 175, 176, 177, 178, 179, 180
                </div>
                <div class="college-info" contenteditable="true">
                    HARVESTING, THRESHING AND WINNOWING OF PADDY AT INSTRUCTIONAL FARM<br>
                    B.C.K.V., JAGULI, NADIA
                </div>
            </div>

        </div>
    </div>

    <script>
        // State management
        const imgStates = {};

        function triggerUpload(id) {
            document.getElementById(id).click();
        }

        function loadImage(input, wrapperId) {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const wrapper = document.getElementById(wrapperId);
                    
                    wrapper.innerHTML = ''; 

                    const img = document.createElement('img');
                    img.src = e.target.result;
                    img.style.height = '100%'; 
                    wrapper.appendChild(img);

                    // Initialize State
                    imgStates[wrapperId] = {
                        scale: 1,
                        panning: false,
                        pointX: 0,
                        pointY: 0,
                        startX: 0,
                        startY: 0,
                        rotation: 0,
                        // Pinch Specifics
                        lastDist: 0,
                        pinching: false
                    };

                    attachListeners(wrapper, img, wrapperId);
                }
                reader.readAsDataURL(input.files[0]);
            }
        }

        function attachListeners(wrapper, img, id) {
            const state = imgStates[id];

            // --- MOUSE EVENTS (Desktop) ---
            wrapper.addEventListener('wheel', (e) => {
                e.preventDefault();
                const xs = (e.clientX - wrapper.getBoundingClientRect().left - state.pointX) / state.scale;
                const ys = (e.clientY - wrapper.getBoundingClientRect().top - state.pointY) / state.scale;
                
                const delta = -e.deltaY;
                (delta > 0) ? (state.scale *= 1.1) : (state.scale /= 1.1);
                
                state.pointX = e.clientX - wrapper.getBoundingClientRect().left - xs * state.scale;
                state.pointY = e.clientY - wrapper.getBoundingClientRect().top - ys * state.scale;

                updateTransform(img, state);
            });

            wrapper.addEventListener('dblclick', (e) => {
                e.preventDefault();
                state.rotation = (state.rotation + 90) % 360;
                updateTransform(img, state);
            });

            wrapper.addEventListener('mousedown', (e) => {
                if(e.target.closest('.placeholder-text')) return;
                e.preventDefault();
                state.startX = e.clientX - state.pointX;
                state.startY = e.clientY - state.pointY;
                state.panning = true;
                wrapper.style.cursor = 'grabbing';
            });

            window.addEventListener('mouseup', () => {
                state.panning = false;
                wrapper.style.cursor = 'grab';
            });

            window.addEventListener('mousemove', (e) => {
                if (!state.panning) return;
                e.preventDefault();
                state.pointX = e.clientX - state.startX;
                state.pointY = e.clientY - state.startY;
                updateTransform(img, state);
            });


            // --- TOUCH EVENTS (Mobile/Tablet) ---
            
            // Helper to get distance between two fingers
            function getDistance(touches) {
                const dx = touches[0].clientX - touches[1].clientX;
                const dy = touches[0].clientY - touches[1].clientY;
                return Math.sqrt(dx * dx + dy * dy);
            }

            wrapper.addEventListener('touchstart', (e) => {
                if(e.touches.length === 1) {
                    // Start Pan
                    state.panning = true;
                    state.pinching = false;
                    state.startX = e.touches[0].clientX - state.pointX;
                    state.startY = e.touches[0].clientY - state.pointY;
                } else if (e.touches.length === 2) {
                    // Start Pinch
                    e.preventDefault(); // Stop browser zoom
                    state.panning = false;
                    state.pinching = true;
                    state.lastDist = getDistance(e.touches);
                }
            }, {passive: false});

            wrapper.addEventListener('touchmove', (e) => {
                if(state.panning && e.touches.length === 1) {
                    e.preventDefault();
                    state.pointX = e.touches[0].clientX - state.startX;
                    state.pointY = e.touches[0].clientY - state.startY;
                    updateTransform(img, state);
                } else if (state.pinching && e.touches.length === 2) {
                    e.preventDefault();
                    const dist = getDistance(e.touches);
                    // Calculate Zoom Factor
                    const zoomFactor = dist / state.lastDist;
                    
                    // Apply relative zoom
                    state.scale *= zoomFactor;
                    
                    // Prevent too small
                    if(state.scale < 0.1) state.scale = 0.1;
                    
                    state.lastDist = dist;
                    updateTransform(img, state);
                }
            }, {passive: false});

            wrapper.addEventListener('touchend', (e) => {
                state.panning = false;
                state.pinching = false;
            });
        }

        function updateTransform(img, state) {
            img.style.transform = `translate(${state.pointX}px, ${state.pointY}px) scale(${state.scale}) rotate(${state.rotation}deg)`;
        }

        // Export Functions
        async function prepareCanvas() {
            const placeholders = document.querySelectorAll('.placeholder-text');
            placeholders.forEach(p => p.style.opacity = '0');
            const wrappers = document.querySelectorAll('.img-wrapper');
            wrappers.forEach(w => w.style.border = 'none');

            // Temporarily reset page transform for clean capture if needed
            // But usually HTML2Canvas handles DOM state
            
            const element = document.getElementById("canvas-container");
            const canvas = await html2canvas(element, {
                scale: 2, 
                useCORS: true,
                allowTaint: true
            });

            placeholders.forEach(p => p.style.opacity = '1');
            wrappers.forEach(w => w.style.border = '1px dashed #ccc');
            
            return canvas;
        }

        async function downloadImage(format) {
            const canvas = await prepareCanvas();
            const link = document.createElement('a');
            link.download = `bckv-field-card.${format}`;
            link.href = canvas.toDataURL(`image/${format}`);
            link.click();
        }

        async function downloadPDF() {
            const { jsPDF } = window.jspdf;
            const canvas = await prepareCanvas();
            const imgData = canvas.toDataURL('image/jpeg', 1.0);
            
            const pdf = new jsPDF('p', 'mm', 'a4');
            const pdfWidth = pdf.internal.pageSize.getWidth();
            const pdfHeight = pdf.internal.pageSize.getHeight();
            
            pdf.addImage(imgData, 'JPEG', 0, 0, pdfWidth, pdfHeight);
            pdf.save('bckv-field-card.pdf');
        }
    </script>
</body>
</html>
