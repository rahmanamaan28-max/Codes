<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>BCKV Field Data Card</title>
    <!-- Libraries for PDF Export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <style>
        :root {
            --border-color: #1a5e1a;
            --text-maroon: #990033;
            --text-brown: #5c2821;
        }

        body {
            font-family: Arial, sans-serif;
            background-color: #333; /* Dark background to see the paper better */
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            height: 100vh;
            overflow: hidden; /* Prevent body scroll, we zoom the canvas instead */
            touch-action: none;
        }

        /* --- UI CONTROLS --- */
        .ui-bar {
            background: white;
            width: 100%;
            padding: 10px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            z-index: 1000;
            display: flex;
            gap: 10px;
            justify-content: center;
            flex-wrap: wrap;
            flex-shrink: 0;
        }

        .btn {
            background: var(--border-color);
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 4px;
            font-size: 14px;
            cursor: pointer;
        }

        .info-text {
            width: 100%;
            text-align: center;
            font-size: 12px;
            color: #666;
            margin-top: 5px;
        }

        /* --- WORKSPACE --- */
        #workspace {
            flex-grow: 1;
            width: 100%;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            overflow: auto; /* Allow scrolling if zoomed in */
            padding: 20px;
            box-sizing: border-box;
            background: #555;
            touch-action: none; /* Handled by JS */
        }

        /* --- A4 SHEET --- */
        /* Dimensions are fixed to A4 pixel ratio at 96dpi (794x1123) */
        #canvas-container {
            width: 794px;
            height: 1123px;
            background-color: white;
            border: 8px solid var(--border-color);
            position: relative;
            box-shadow: 0 0 20px rgba(0,0,0,0.5);
            /* Important: This allows us to scale it via JS */
            transform-origin: top center; 
            flex-shrink: 0;
        }

        .layout-grid {
            display: flex;
            flex-direction: column;
            gap: 15px;
            height: 100%;
            padding: 15px;
            box-sizing: border-box;
        }

        /* --- IMAGE SLOTS --- */
        .img-wrapper {
            position: relative;
            background-color: #eee;
            overflow: hidden;
            border: 1px dashed #aaa;
            cursor: grab;
            display: flex;
            align-items: center;
            justify-content: center;
            touch-action: none; /* Vital for pointer events */
        }
        
        .img-wrapper.active {
            border: 2px solid blue;
        }

        .img-wrapper img {
            position: absolute;
            /* Start centered */
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
            /* Prevent default drag ghost image */
            user-select: none;
            pointer-events: none;
            max-width: none; /* Allow unlimited scaling */
        }

        .placeholder-text {
            pointer-events: none;
            color: #777;
            font-size: 14px;
            text-align: center;
            padding: 10px;
        }

        /* --- SECTIONS --- */
        /* Fixed: Top section now flexes correctly */
        .top-section { 
            height: 340px; 
            display: flex; 
            flex-direction: column; 
        }

        .middle-grid, .bottom-grid { 
            display: grid; 
            grid-template-columns: 1fr 1fr 1fr; 
            gap: 10px; 
            height: 250px; 
        }

        /* --- TEXT --- */
        .caption {
            text-align: center;
            font-size: 16px;
            margin-top: 5px;
            border: 1px solid transparent;
        }
        .caption:focus { border-bottom: 1px solid blue; outline: none; background: #fffec4; }

        .footer-text { margin-top: auto; text-align: center; line-height: 1.4; }
        .group-info { color: var(--text-maroon); font-weight: bold; font-size: 18px; text-transform: uppercase; }
        .college-info { color: var(--text-brown); font-weight: bold; font-size: 20px; font-family: 'Arial Black', sans-serif; text-transform: uppercase; }

        input[type="file"] { display: none; }
    </style>
</head>
<body>

    <div class="ui-bar">
        <button class="btn" onclick="downloadImage()">Download JPEG</button>
        <button class="btn" onclick="downloadPDF()">Download PDF</button>
        <div class="info-text">1 Finger: Drag | 2 Fingers: Pinch/Zoom | Double Tap: Rotate</div>
    </div>

    <div id="workspace">
        <div id="canvas-container">
            <div class="layout-grid">
                
                <!-- TOP -->
                <div class="top-section">
                    <!-- FIXED: Added style="flex:1" to ensure it fills the top section -->
                    <div class="img-wrapper" id="wrap-top" style="flex: 1; width: 100%;" onclick="handleUploadClick('wrap-top')">
                        <span class="placeholder-text">Click to Upload Paddy Field</span>
                        <input type="file" accept="image/*" onchange="fileLoaded(this, 'wrap-top')">
                    </div>
                    <div class="caption" contenteditable="true">Paddy Field</div>
                </div>

                <!-- MIDDLE -->
                <div class="middle-grid">
                    <div style="display:flex; flex-direction:column;">
                        <div class="img-wrapper" style="height:100%" id="wrap-m1" onclick="handleUploadClick('wrap-m1')">
                            <span class="placeholder-text">Upload</span>
                            <input type="file" accept="image/*" onchange="fileLoaded(this, 'wrap-m1')">
                        </div>
                        <div class="caption" contenteditable="true">Harvesting of paddy</div>
                    </div>
                    <div style="display:flex; flex-direction:column;">
                        <div class="img-wrapper" style="height:100%" id="wrap-m2" onclick="handleUploadClick('wrap-m2')">
                            <span class="placeholder-text">Upload</span>
                            <input type="file" accept="image/*" onchange="fileLoaded(this, 'wrap-m2')">
                        </div>
                        <div class="caption" contenteditable="true">Harvesting in group</div>
                    </div>
                    <div style="display:flex; flex-direction:column;">
                        <div class="img-wrapper" style="height:100%" id="wrap-m3" onclick="handleUploadClick('wrap-m3')">
                            <span class="placeholder-text">Upload</span>
                            <input type="file" accept="image/*" onchange="fileLoaded(this, 'wrap-m3')">
                        </div>
                        <div class="caption" contenteditable="true">Threshing of paddy</div>
                    </div>
                </div>

                <!-- BOTTOM -->
                <div class="bottom-grid">
                    <div style="display:flex; flex-direction:column;">
                        <div class="img-wrapper" style="height:100%" id="wrap-b1" onclick="handleUploadClick('wrap-b1')">
                            <span class="placeholder-text">Upload</span>
                            <input type="file" accept="image/*" onchange="fileLoaded(this, 'wrap-b1')">
                        </div>
                        <div class="caption" contenteditable="true">Winnowing</div>
                    </div>
                    <div style="display:flex; flex-direction:column;">
                        <div class="img-wrapper" style="height:100%" id="wrap-b2" onclick="handleUploadClick('wrap-b2')">
                            <span class="placeholder-text">Upload</span>
                            <input type="file" accept="image/*" onchange="fileLoaded(this, 'wrap-b2')">
                        </div>
                        <div class="caption" contenteditable="true">Weighing of grain</div>
                    </div>
                    <div style="display:flex; flex-direction:column;">
                        <div class="img-wrapper" style="height:100%" id="wrap-b3" onclick="handleUploadClick('wrap-b3')">
                            <span class="placeholder-text">Upload</span>
                            <input type="file" accept="image/*" onchange="fileLoaded(this, 'wrap-b3')">
                        </div>
                        <div class="caption" contenteditable="true">Weighing of straw</div>
                    </div>
                </div>

                <!-- FOOTER -->
                <div class="footer-text">
                    <div class="group-info" contenteditable="true">
                        GROUP R : AG 171, 172, 173, 174, 175, 176, 177, 178, 179, 180
                    </div>
                    <div class="college-info" contenteditable="true">
                        HARVESTING, THRESHING AND WINNOWING OF PADDY AT INSTRUCTIONAL FARM<br>
                        B.C.K.V., JAGULI, NADIA
                    </div>
                </div>

            </div>
        </div>
    </div>

    <script>
        // --- 1. RESPONSIVE SCALING ---
        const container = document.getElementById('canvas-container');
        let globalScale = 1;

        function fitToScreen() {
            // A4 width is 794px
            const screenW = window.innerWidth;
            const margin = 20; 
            const availableW = screenW - margin;
            
            // Calculate scale to fit screen, maxing out at 1 (100%)
            globalScale = availableW < 794 ? availableW / 794 : 1;
            
            // Apply scale
            container.style.transform = `scale(${globalScale})`;
            
            // Adjust height of workspace so user can scroll to bottom of scaled page
            const scaledHeight = 1123 * globalScale;
            container.style.marginBottom = `${-(1123 - scaledHeight)}px`; // Pull up empty space
        }
        
        window.addEventListener('resize', fitToScreen);
        window.addEventListener('load', fitToScreen);


        // --- 2. IMAGE HANDLING STATE ---
        // Store transforms for every image wrapper ID
        const transforms = {}; 

        // Current Interaction State
        let activeWrapper = null;
        let evCache = []; // Pointer cache for multi-touch
        let prevDiff = -1;
        let isDragging = false;
        
        // Initial values on pointer down
        let startX = 0, startY = 0;
        let initialTx = 0, initialTy = 0;

        function getTransform(id) {
            if(!transforms[id]) {
                transforms[id] = { x: 0, y: 0, scale: 1, rotate: 0 };
            }
            return transforms[id];
        }

        // --- 3. UPLOAD LOGIC ---
        function handleUploadClick(id) {
            // Only trigger upload if we are NOT dragging/pinching
            const input = document.querySelector(`#${id} input`);
            
            // If image is missing, click ALWAYS uploads
            if (!document.querySelector(`#${id} img`)) {
                input.click();
            } 
            // If image exists, only upload if we weren't just manipulating it
            // (The pointer events will stop propagation if dragging occurred, 
            // but for simple click to re-upload, we allow it if user taps quickly)
            else {
                // Optional: Allow re-upload on click if you want
                // input.click(); 
            }
        }

        function fileLoaded(input, id) {
            if(input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const wrapper = document.getElementById(id);
                    // Remove placeholder
                    const ph = wrapper.querySelector('.placeholder-text');
                    if(ph) ph.remove();
                    
                    // Remove existing img
                    const existing = wrapper.querySelector('img');
                    if(existing) existing.remove();

                    // Add new img
                    const img = document.createElement('img');
                    img.src = e.target.result;
                    img.id = `img-${id}`;
                    
                    // Initial Fit Strategy
                    // For Top Image (wide), width 100% is usually safer initial state
                    // For Grid Images (square-ish), height 100% is usually safer
                    if(id === 'wrap-top') {
                         img.style.width = '100%';
                         img.style.height = 'auto';
                    } else {
                         img.style.height = '100%'; 
                         img.style.width = 'auto';
                    }

                    wrapper.appendChild(img);
                    
                    // Reset transform
                    transforms[id] = { x: 0, y: 0, scale: 1, rotate: 0 }; // Start centered (0,0 translates)
                    applyTransform(img, transforms[id]);
                    
                    // Attach Pointer Events
                    initPointerEvents(wrapper, img, id);
                };
                reader.readAsDataURL(input.files[0]);
            }
        }


        // --- 4. POINTER EVENTS (TOUCH & MOUSE) ---
        function initPointerEvents(wrapper, img, id) {
            wrapper.addEventListener('pointerdown', (e) => {
                e.preventDefault(); // Stop browser scrolling
                wrapper.setPointerCapture(e.pointerId);
                evCache.push(e);
                activeWrapper = wrapper;

                const t = getTransform(id);

                if (evCache.length === 1) {
                    // Start Drag
                    isDragging = true;
                    startX = e.clientX;
                    startY = e.clientY;
                    initialTx = t.x;
                    initialTy = t.y;
                } 
                else if (evCache.length === 2) {
                    // Start Pinch
                    isDragging = false;
                    prevDiff = getDistance(evCache[0], evCache[1]);
                }
            });

            wrapper.addEventListener('pointermove', (e) => {
                const index = evCache.findIndex(cached => cached.pointerId === e.pointerId);
                if(index > -1) evCache[index] = e; // Update cache

                if (!activeWrapper || activeWrapper !== wrapper) return;
                const t = getTransform(id);

                // --- DRAG (1 Finger) ---
                if (evCache.length === 1) {
                    const dx = (e.clientX - startX) / globalScale; // Adjust for Global Zoom
                    const dy = (e.clientY - startY) / globalScale;
                    
                    t.x = initialTx + dx;
                    t.y = initialTy + dy;
                    
                    applyTransform(img, t);
                }
                
                // --- PINCH (2 Fingers) ---
                else if (evCache.length === 2) {
                    const curDiff = getDistance(evCache[0], evCache[1]);
                    if (prevDiff > 0) {
                        // Calculate zoom factor
                        const delta = curDiff - prevDiff;
                        // Sensitivity factor
                        const zoomSpeed = 0.01; 
                        
                        t.scale += delta * zoomSpeed;
                        if (t.scale < 0.1) t.scale = 0.1; // Min zoom
                        
                        applyTransform(img, t);
                    }
                    prevDiff = curDiff;
                }
            });

            wrapper.addEventListener('pointerup', handlePointerUp);
            wrapper.addEventListener('pointercancel', handlePointerUp);
            wrapper.addEventListener('pointerout', handlePointerUp);
            wrapper.addEventListener('pointerleave', handlePointerUp);

            function handlePointerUp(e) {
                const index = evCache.findIndex(cached => cached.pointerId === e.pointerId);
                if (index > -1) evCache.splice(index, 1);
                
                if (evCache.length < 2) prevDiff = -1;
                if (evCache.length === 0) activeWrapper = null;
            }
            
            // Double Click for Rotate (Works on mobile as double tap often)
            wrapper.addEventListener('dblclick', (e) => {
                const t = getTransform(id);
                t.rotate = (t.rotate + 90) % 360;
                applyTransform(img, t);
            });
        }

        function getDistance(p1, p2) {
            const dx = p1.clientX - p2.clientX;
            const dy = p1.clientY - p2.clientY;
            return Math.sqrt(dx * dx + dy * dy);
        }

        function applyTransform(img, t) {
            // Logic:
            // 1. Position absolute, left 50%, top 50%.
            // 2. transform: translate(tx, ty) scale(s) rotate(r) translate(-50%, -50%)
            // This ensures scaling happens from center, and rotation happens from center.
            img.style.transform = `translate(${t.x}px, ${t.y}px) scale(${t.scale}) rotate(${t.rotate}deg) translate(-50%, -50%)`;
        }

        // --- 5. EXPORT ---
        async function downloadImage() {
            const element = document.getElementById("canvas-container");
            
            // Hide borders/placeholders
            const dashed = document.querySelectorAll('.img-wrapper');
            dashed.forEach(d => d.style.border = 'none');
            const placeholders = document.querySelectorAll('.placeholder-text');
            placeholders.forEach(p => p.style.opacity = '0');

            // Force scale to 1 for high res capture, then restore
            const oldTransform = element.style.transform;
            const oldMargin = element.style.marginBottom;
            element.style.transform = 'scale(1)';
            element.style.marginBottom = '0';

            const canvas = await html2canvas(element, {
                scale: 2, // High res
                useCORS: true,
                windowWidth: 794,
                windowHeight: 1123
            });

            // Restore
            element.style.transform = oldTransform;
            element.style.marginBottom = oldMargin;
            dashed.forEach(d => d.style.border = '1px dashed #aaa');
            placeholders.forEach(p => p.style.opacity = '1');

            const link = document.createElement('a');
            link.download = 'bckv_card.jpg';
            link.href = canvas.toDataURL('image/jpeg', 0.9);
            link.click();
        }

        async function downloadPDF() {
            const element = document.getElementById("canvas-container");
            
            // Hide UI elements
            const dashed = document.querySelectorAll('.img-wrapper');
            dashed.forEach(d => d.style.border = 'none');
            const placeholders = document.querySelectorAll('.placeholder-text');
            placeholders.forEach(p => p.style.opacity = '0');

            // Reset scale for capture
            const oldTransform = element.style.transform;
            const oldMargin = element.style.marginBottom;
            element.style.transform = 'scale(1)';
            element.style.marginBottom = '0';

            const canvas = await html2canvas(element, { scale: 2, useCORS: true });
            
            // Restore UI
            element.style.transform = oldTransform;
            element.style.marginBottom = oldMargin;
            dashed.forEach(d => d.style.border = '1px dashed #aaa');
            placeholders.forEach(p => p.style.opacity = '1');

            const imgData = canvas.toDataURL('image/jpeg', 0.9);
            const { jsPDF } = window.jspdf;
            const pdf = new jsPDF('p', 'mm', 'a4');
            const w = pdf.internal.pageSize.getWidth();
            const h = pdf.internal.pageSize.getHeight();
            
            pdf.addImage(imgData, 'JPEG', 0, 0, w, h);
            pdf.save('bckv_card.pdf');
        }

    </script>
</body>
</html>
